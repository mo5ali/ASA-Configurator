<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurator</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100vh;
        overflow: hidden; /* Disable scrolling */
        font-family: Arial, sans-serif;
        background:  #f8f8f8;
      }

      .main-layout {
        display: flex;
        height: 100vh;
        width: 100vw;
      }

      /* Left panel - 40% width */
      .controls-panel {
        width: 40%;
        background: white;
        padding: 20px;
        border-right: 2px solid #ddd;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Right panel - 60% width */
      .viewer-panel {
        width: 60%;
        position: relative;
        background: #f0f0f0;
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom:  2px solid #ddd;
      }

      .header img {
        height: 50px;
        width: auto;
      }

      .header h2 {
        margin: 0;
        color: #333;
      }

      /* Control groups - labels next to dropdowns */
      .control-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
      }

      .control-group label {
        min-width: 140px;
        font-weight:  500;
        color: #555;
        font-size: 14px;
      }

      .control-group select {
        flex: 1;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius:  4px;
        background:  white;
      }

      .control-group select:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor:  not-allowed;
      }

      /* Inline controls - labels above, dropdowns side by side */
      .inline-controls {
        margin-bottom: 15px;
      }

      .inline-controls-header {
        font-weight: 500;
        color: #555;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .inline-controls-row {
        display: flex;
        gap: 12px;
      }

      .inline-control {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .inline-control label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
      }

      .inline-control select {
        padding: 8px;
        font-size:  14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      /* Conditional groups */
      .conditional-group {
        margin-top: 10px;
        padding: 0;
        background: transparent;
        border-radius: 0;
        border: none;
      }

      .conditional-group small {
        display: block;
        margin-top: 4px;
        color: #666;
        font-size: 11px;
      }

      /* Code display area */
      .code-display {
        background: white;
        padding: 15px;
        border-radius:  6px;
        border:  1px solid #ddd;
        margin:  20px 0;
      }

      .position-grid {
        display: grid;
        grid-template-columns: repeat(9, 1fr); /* 2 rows of 9 */
        gap: 6px;
        margin-bottom: 10px;
      }

      .position-box {
        width: 28px;
        height: 28px;
        border: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        background-color: #f9f9f9;
        font-family: monospace;
        border-radius: 3px;
      }

      .position-box.filled {
        background-color: #e8f5e8;
        border-color: #4CAF50;
      }

      .final-code {
        margin-top: 10px;
        padding: 12px;
        border:  2px solid #333;
        background-color: #f0f0f0;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        font-family: monospace;
        border-radius: 4px;
      }

      /* Viewer area */
      .viewer-content {
        flex: 1;
        position: relative;
        margin:  20px;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
        overflow: hidden;
      }

      #previewImage {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      #overlayImage {
        position: absolute;
        left: 0;
        top:  0;
        width: 0;
        height: auto;
        display: none;
        pointer-events: none;
        mix-blend-mode: normal;
      }

      #simple3DViewer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        z-index: 10;
        background: #f0f0f0;
      }

      #threeCanvas {
        width: 100%;
        height:  100%;
      }

      #loading3D {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 8px;
        font-family: Arial;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
      }

      #toggle3D {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 20;
        padding: 10px 16px;
        background: rgba(255,255,255,0.95);
        border: 1px solid #ccc;
        border-radius:  6px;
        cursor: pointer;
        font-size: 13px;
        font-weight:  600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
      }

      #toggle3D:hover {
        background: white;
        border-color: #999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .copyright {
        position: absolute;
        bottom: 15px;
        right: 15px;
        font-size: 11px;
        color: #666;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 10px;
        border-radius:  4px;
        border: 1px solid #ddd;
      }

      .copyright a {
        color: #666;
        text-decoration: none;
      }

      .copyright a:hover {
        text-decoration: underline;
      }

      .hidden {
        display: none ! important;
      }

      /* Scrollbar styling for webkit browsers */
      .controls-panel::-webkit-scrollbar {
        width: 8px;
      }

      .controls-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .controls-panel::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .controls-panel::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
    </style>
  </head>
  <body>
    <div class="main-layout">
      <!-- Left Panel - 40% width -->
      <div class="controls-panel">
        <div class="header">
          <img src="Z:\Allgemein\Temp\MA\ASA-2017-clear-q5wbyrbl7shpdhw75ixpkziyjbxg04yk9z9dpdln6s.png" alt="ASA Logo">
          <h2>Configurator</h2>
        </div>

        <div class="control-group">
          <label for="productFamily">Cooler Line:</label>
          <select id="productFamily"></select>
        </div>

        <div class="control-group">
          <label for="size">Size:</label>
          <select id="size" disabled></select>
        </div>

        <div class="control-group">
          <label for="bypassType">Bypass: </label>
          <select id="bypassType">
            <option value="">Select bypass type... </option>
            <option value="No Bypass">No Bypass</option>
            <option value="Thermal Bypass">Thermal Bypass</option>
            <option value="Pressure Bypass 2 bar">Pressure Bypass 2 bar</option>
            <option value="Pressure Bypass 5 bar">Pressure Bypass 5 bar</option>
            <option value="Pressure Bypass Special">Pressure Bypass Special</option>
          </select>
        </div>

        <!-- Inline controls for Drive configuration -->
        <div class="inline-controls">
          <div class="inline-controls-header">Drive Configuration: </div>
          <div class="inline-controls-row">
            <div class="inline-control">
              <label for="DriveType">Type:</label>
              <select id="DriveType">
                <option value="">Select type...</option>
                <option value="AC">AC</option>
                <option value="DC - brushed">DC - brushed</option>
                <option value="DC - brushless">DC - brushless</option>
                <option value="Compact">Compact</option>
                <option value="Hydraulic">Hydraulic</option>
              </select>
            </div>
            <div class="inline-control">
              <label for="placeholder1" id="placeholder1Label">Option 1:</label>
              <select id="placeholder1">
                <option value="">--</option>
              </select>
            </div>
            <div class="inline-control" id="placeholder2Group">
              <label for="placeholder2" id="placeholder2Label">Option 2:</label>
              <select id="placeholder2">
                <option value="">--</option>
              </select>
            </div>
          </div>
        </div>

        <div class="control-group">
          <label for="temperatureSensor">Temp.  Control:</label>
          <select id="temperatureSensor">
            <option value="">Select temperature control...</option>
            <option value="No Sensor">No Sensor</option>
            <option value="Temperature Sensor Standard">Temperature Sensor Standard</option>
            <option value="Temperature Switch 40°C">Temperature Switch 40°C</option>
            <option value="Temperature Switch 50°C">Temperature Switch 50°C</option>
            <option value="Temperature Switch 60°C">Temperature Switch 60°C</option>
            <option value="Temperature Switch 70°C">Temperature Switch 70°C</option>
            <option value="Temperature Switch 80°C">Temperature Switch 80°C</option>
            <option value="Temperature Switch 90°C">Temperature Switch 90°C</option>
            <option value="Temperature Control AC">Temperature Control AC</option>
          </select>
        </div>

        <!-- Conditional groups -->
        <div class="conditional-group hidden" id="sideRailGroup">
          <div class="control-group">
            <label for="sideRail">Side-Rail:</label>
            <select id="sideRail">
              <option value="">Select Side-Rail...</option>
              <option value="00">keine Lasche</option>
              <option value="U0">U-Lasche Standard</option>
              <option value="U1">U-Lasche Variante 1</option>
              <option value="V0">U-Lasche mit MDG* Standard</option>
              <option value="V1">U-Lasche mit MDG* Variante 1</option>
              <option value="F0">U-Lasche mit Füssen</option>
              <option value="G0">U-Lasche mit MDG* und Schutzgehäuse ("GT")</option>
              <option value="W0">U-Laschen, Blechteile in W-Ausführung Standard</option>
              <option value="LB">L-Lasche gelötet</option>
              <option value="UB">U-Lasche gelötet</option>
              <option value="X0">Kundenspezifische Anbauteile Side</option>
            </select>
          </div>
        </div>

        <div class="conditional-group hidden" id="topRailGroup">
          <div class="control-group">
            <label for="topRail">Top Rail:</label>
            <select id="topRail">
              <option value="">Select Top Rail accessory...</option>
              <option value="0">keine Anbauteile auf Top Rail</option>
              <option value="S">Railfüsse (Standard)</option>
              <option value="H">Railfüsse (HD)</option>
              <option value="L">Railfüsse (Lange Version)</option>
              <option value="T">Railfüsse (Standard) mit MDG*</option>
              <option value="I">Railfüsse (HD) mit MDG*</option>
              <option value="M">Railfüsse (Lange Version) mit MDG*</option>
              <option value="A">Hebeösen</option>
              <option value="X">Kundenspezifische Anbauteile Top</option>
            </select>
          </div>
        </div>

        <div class="control-group">
          <label for="anschlussart">Connection: </label>
          <select id="anschlussart">
            <option value="">Select connection type... </option>
            <option value="0">kein Anschluss</option>
            <option value="G">G - Gewinde Anschlüsse (BSP-Gewinde)</option>
            <option value="M">M - Metrische-Gewinde Anschlüsse</option>
            <option value="S">S - SAE-Anschlüsse (SAE 4-Loch)</option>
            <option value="U">U - UNF-Gewinde Anschlüsse (SAE O-Ring)</option>
          </select>
        </div>

        <!-- Code display -->
        <div class="code-display">
          <h4 style="margin-bottom: 10px; color: #333;">Product Code Positions:</h4>
          <div class="position-grid">
            <div class="position-box" id="pos1">-</div>
            <div class="position-box" id="pos2">-</div>
            <div class="position-box" id="pos3">-</div>
            <div class="position-box" id="pos4">-</div>
            <div class="position-box" id="pos5">-</div>
            <div class="position-box" id="pos6">-</div>
            <div class="position-box" id="pos7">-</div>
            <div class="position-box" id="pos8">-</div>
            <div class="position-box" id="pos9">-</div>
            <div class="position-box" id="pos10">-</div>
            <div class="position-box" id="pos11">-</div>
            <div class="position-box" id="pos12">-</div>
            <div class="position-box" id="pos13">-</div>
            <div class="position-box" id="pos14">-</div>
            <div class="position-box" id="pos15">-</div>
            <div class="position-box" id="pos16">-</div>
            <div class="position-box" id="pos17">-</div>
            <div class="position-box" id="pos18">-</div>
          </div>
          <div class="final-code" id="finalCode">Select options to generate code...</div>
        </div>
      </div>

      <!-- Right Panel - 60% width -->
      <div class="viewer-panel">
        <div class="viewer-content">
          <img id="previewImage" src="" alt="Preview" />
          <img id="overlayImage" src="" alt="Overlay" />
          
          <div id="simple3DViewer">
            <canvas id="threeCanvas"></canvas>
            <div id="loading3D">Loading model...</div>
          </div>
          
          <button id="toggle3D">Show 3D</button>
        </div>
      </div>
    </div>

    <div class="copyright">
      © 2024 mo5ali & <a href="https://claude.ai" target="_blank">Claude</a>
    </div>
    <script>

  // Product configuration arrays
  const productFamilyOptions = [
    "",
    "Rail 1 (64mm)",
    "Rail 2 (94mm)",
    "Rail 3 (50mm)",
    "ASA-C Serie 50mm (ehem. Low Line)",
    "ASA-C Serie 64mm (ehem. E-Serie)",
    "AUC-Serie, Standard (Anschluss links)",
    "AUC-Serie (ehem. AHP, Anschluss rechts)"
  ];

  const sizeOptions = {
    "Rail 1 (64mm)": ["", "45", "75", "105", "135", "175", "235", "275", "375", "385"],
    "AUC-Serie, Standard (Anschluss links)": ["", "177", "257", "367", "467", "567", "927", "275", "375", "385"],
    "AUC-Serie (ehem. AHP, Anschluss rechts)": ["", "177", "257", "367", "467", "567", "927", "275", "375", "385"],
    "ASA-C Serie 64mm (ehem. E-Serie)": ["", "6", "7", "9", "13", "17", "20", "23", "375"],
    "ASA-C Serie 50mm (ehem. Low Line)": ["", "44", "64", "104", "164"]
  };

  const specialImageMap = {
    "Rail 1 (64mm)|105": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX11 with dims. svg",
    "Rail 1 (64mm)|45": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX05. png",
    "Rail 1 (64mm)|75": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX07.png",
    "Rail 1 (64mm)|135": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX13.png",
    "Rail 1 (64mm)|175": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX16.png",
    "Rail 1 (64mm)|235": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX21.png",
    "Rail 1 (64mm)|375": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX40.png",
    "Rail 1 (64mm)|385": "Z:\\Allgemein\\Temp\\MA\\VECTORS\\ILLEX36.png"
  };

  const anschlussMOverlaySrc = "file:///Z:/Allgemein/Temp/MA/VECTORS/ILLZET53G26.png";

  const overlayMap = {
    "Rail 1 (64mm)|105": { left: 9.5, top: 1.75, width: 27 },
    "Rail 1 (64mm)|45": { left: 42, top: 30, width: 18 },
    "Rail 2 (94mm)|177": { left: 50, top: 32, width: 20 },
    "Rail 1 (64mm)|*": { left: 44, top: 29, width: 20 },
    "Rail 2 (94mm)|*": { left: 48, top: 31, width: 22 },
    "Rail 3 (50mm)|*": { left: 40, top: 34, width: 18 }
  };

  const overlayDefault = { left: 45, top: 30, width:  20 };
      
      // Repository URLs for 3D models (replace with your actual repository URLs)
      const modelUrls = {
        "Rail 1 (64mm)|135": {
          obj: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/ILLEX13_obj.txt",
          mtl: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/ILLEX13_mtl.txt"
        },
        "Rail 1 (64mm)|105": {
          obj: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail1_105_obj.txt",
          mtl: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail1_105_mtl.txt"
        },
        "Rail 1 (64mm)|75": {
          obj: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail1_75_obj.txt",
          mtl: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail1_75_mtl.txt"
        },
        "Rail 2 (94mm)|177": {
          obj: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail2_177_obj.txt",
          mtl: "https://raw.githubusercontent.com/mo5ali/ASA-Configurator/master/3D_Models/Rail2_177_mtl.txt"
        }
        // Add more model mappings as needed
      };

      // Function to load text content from repository URL
      async function loadFromRepo(url) {
        try {
          console.log('Fetching from repository:', url);
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const text = await response.text();
          console.log('Successfully fetched from repo, content length:', text.length);
          
          return text;
        } catch (error) {
          console.error('Error fetching from repository:', url, 'Error:', error.message);
          return '';
        }
      }

      // 3D Viewer variables
      let scene3D, camera3D, renderer3D, controls3D, currentModel3D;
      let is3DMode = false;

      // Configuration
      const BACKGROUND_COLOR = 0xf0f0f0;  // Light grey like your page
      const MODEL_COLOR = 0x607D8B;      // CAD-like blue-grey

      function toggle3DView() {
        const viewer3D = document.getElementById('simple3DViewer');
        const toggleBtn = document.getElementById('toggle3D');
        
        is3DMode = !is3DMode;
        
        if (is3DMode) {
          viewer3D.style.display = 'block';
          toggleBtn.textContent = 'Show 2D';
          if (! renderer3D) {
            init3DViewer();
          }
          load3DModel();
        } else {
          viewer3D.style.display = 'none';
          toggleBtn.textContent = 'Show 3D';
        }
      }

      function init3DViewer() {
        const canvas = document.getElementById('threeCanvas');
        const container = document.getElementById('simple3DViewer');
        
        // Create scene with light grey background
        scene3D = new THREE.Scene();
        scene3D.background = new THREE.Color(BACKGROUND_COLOR);
        
        // Create camera
        camera3D = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
        camera3D.position. set(3, 2, 5);
        
        // Create renderer
        renderer3D = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer3D.setSize(container.offsetWidth, container.offsetHeight);
        renderer3D.setPixelRatio(window.devicePixelRatio);
        
        // Add OrbitControls (pan, rotate, zoom) - PROPER CAD CONTROLS! 
        controls3D = new THREE.OrbitControls(camera3D, renderer3D.domElement);
        controls3D.enableDamping = true;
        controls3D.dampingFactor = 0.05;
        controls3D.screenSpacePanning = false;
        controls3D.minDistance = 0.1;
        controls3D. maxDistance = 100;
        controls3D.maxPolarAngle = Math.PI;
        
        // Add professional lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene3D.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight.position. set(5, 10, 7);
        scene3D.add(directionalLight);
        
        // Handle canvas resize
        const resizeObserver = new ResizeObserver(() => {
          const rect = container.getBoundingClientRect();
          camera3D.aspect = rect.width / rect.height;
          camera3D.updateProjectionMatrix();
          renderer3D.setSize(rect.width, rect.height);
        });
        resizeObserver.observe(container);
        
        // Start animation loop
        animate3D();
        
        console.log('3D viewer initialized with DeepSeek-style controls');
      }

      function load3DModel() {
        const selections = getCurrentSelections();
        const key = `${selections.productFamily}|${selections.size}`;
        const loading = document.getElementById('loading3D');
        
        console.log('Loading 3D model for:', key);
        
        // Show loading
        loading.style.display = 'block';
        loading.textContent = 'Loading model from repository...';
        
        // Remove previous model
        if (currentModel3D) {
          scene3D.remove(currentModel3D);
          currentModel3D = null;
        }
        
        // Check if we have URLs for this model
        if (modelUrls[key]) {
          const urls = modelUrls[key];
          console.log('Found model URLs:', urls);
          
          // Load both OBJ and MTL files from repository
          Promise.all([
            loadFromRepo(urls.obj),
            loadFromRepo(urls.mtl)
          ]).then(([objContent, mtlContent]) => {
            console.log('Files loaded - OBJ length:', objContent?.length, 'MTL length:', mtlContent?.length);
            
            if (objContent && objContent.trim() !== '') {
              try {
                loading.textContent = 'Processing 3D model...';
                
                // Use MTL content if available, otherwise use default
                const finalMtlContent = mtlContent || createDefaultMTL();
                
                // Create blob URLs from file content
                const mtlBlob = new Blob([finalMtlContent], { type: 'text/plain' });
                const objBlob = new Blob([objContent], { type: 'text/plain' });
                
                const mtlUrl = URL.createObjectURL(mtlBlob);
                const objUrl = URL.createObjectURL(objBlob);
                
                console.log('Created blob URLs, loading 3D model...');
                
                // Try to load MTL first
                const mtlLoader = new THREE.MTLLoader();
                
                mtlLoader.load(mtlUrl, (materials) => {
                  materials.preload();
                  
                  // Load OBJ with materials
                  const objLoader = new THREE.OBJLoader();
                  objLoader.setMaterials(materials);
                  
                  objLoader.load(objUrl, (object) => {
                    currentModel3D = object;
                    setup3DModel(object);
                    loading.style.display = 'none';
                    console.log('3D model loaded successfully!');
                    
                    // Cleanup URLs
                    URL.revokeObjectURL(mtlUrl);
                    URL.revokeObjectURL(objUrl);
                    
                  }, undefined, (error) => {
                    console.warn('Error loading OBJ with materials, trying without:', error);
                    loadOBJWithoutMaterials(objUrl, mtlUrl);
                  });
                  
                }, undefined, (error) => {
                  console.warn('Error loading MTL, using default material:', error);
                  loadOBJWithoutMaterials(objUrl, mtlUrl);
                });
                
              } catch (error) {
                console.error('Error processing model files:', error);
                createFallback3DModel();
                loading.style.display = 'none';
              }
              
            } else {
              console.log('No OBJ content found, showing test cube');
              createFallback3DModel();
              loading.style.display = 'none';
            }
            
          }).catch((error) => {
            console.error('Error loading model files from repository:', error);
            createFallback3DModel();
            loading.style.display = 'none';
          });
          
        } else {
          console.log('No model URLs configured for this selection:', key);
          createFallback3DModel();
          loading.style.display = 'none';
        }
      }

      function loadOBJWithoutMaterials(objUrl, mtlUrl) {
        const objLoader = new THREE.OBJLoader();
        const loading = document.getElementById('loading3D');
        
        objLoader.load(objUrl, (object) => {
          currentModel3D = object;
          setup3DModel(object);
          loading.style.display = 'none';
          
          // Cleanup URLs
          URL.revokeObjectURL(objUrl);
          if (mtlUrl) URL.revokeObjectURL(mtlUrl);
          
        }, undefined, (error) => {
          console.error('Error loading OBJ:', error);
          createFallback3DModel();
          loading.style.display = 'none';
          
          // Cleanup URLs
          URL.revokeObjectURL(objUrl);
          if (mtlUrl) URL.revokeObjectURL(mtlUrl);
        });
      }

      function setup3DModel(object) {
        // Apply CAD-like material
        object.traverse((child) => {
          if (child.isMesh) {
            child.material = new THREE.MeshLambertMaterial({ 
              color: MODEL_COLOR,
              flatShading: false
            });
          }
        });
        
        // Center and scale model to fit view
        const box = new THREE.Box3().setFromObject(object);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        
        const maxSize = Math.max(size.x, size.y, size.z);
        if (maxSize > 0) {
          const scale = 4 / maxSize;
          object.position.sub(center.multiplyScalar(scale));
          object.scale.setScalar(scale);
        }
        
        scene3D.add(object);
        
        // Reset camera position
        camera3D.position.set(3, 2, 5);
        controls3D.reset();
        
        console.log('3D model setup complete');
      }

      function createFallback3DModel() {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE. MeshLambertMaterial({ color: 0xff4444 });
        currentModel3D = new THREE. Mesh(geometry, material);
        scene3D.add(currentModel3D);
        
        camera3D.position.set(3, 2, 5);
        controls3D.reset();
        
        console.log('Fallback cube created');
      }

      function createDefaultMTL() {
        return `# Default Material
      newmtl default
      Ka 0.200000 0.200000 0.200000
      Kd 0.600000 0.600000 0.600000
      Ks 0.000000 0.000000 0.000000
      illum 2
      Ns 20.000000
      Tr 1.000000`;
      }

      function animate3D() {
        if (!renderer3D || !scene3D || !camera3D) return;
        
        requestAnimationFrame(animate3D);
        
        if (controls3D) controls3D.update(); // Required for damping
        
        renderer3D.render(scene3D, camera3D);
      }

      function update3DModel(selections) {
        const toggleBtn = document.getElementById('toggle3D');
        const key = `${selections.productFamily}|${selections.size}`;
        
        // Always show button for testing
        toggleBtn.style.display = 'block';
        
        if (is3DMode && renderer3D) {
          load3DModel();
        }
      }

      // ALL YOUR EXISTING FUNCTIONS STAY EXACTLY THE SAME
      function getCurrentSelections() {
        return {
          productFamily: document. getElementById('productFamily').value,
          size: document.getElementById('size').value,
          DriveType: document.getElementById('DriveType').value,
          temperatureSensor: document.getElementById('temperatureSensor').value,
          bypassType: document.getElementById('bypassType').value,
          placeholder1: document.getElementById('placeholder1').value,
          placeholder2: document.getElementById('placeholder2').value,
          sideRail:  (document.getElementById('sideRail') ?  document.getElementById('sideRail').value : ""),
          topRail: (document.getElementById('topRail') ? document.getElementById('topRail').value : ""),
          anschlussart: (document.getElementById('anschlussart') ? document.getElementById('anschlussart').value : "")
        };
      }

      function initializeDropdowns() {
        const familySelect = document.getElementById('productFamily');
        productFamilyOptions.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          familySelect.appendChild(opt);
        });

        familySelect.addEventListener('change', handleProductFamilyChange);

        ['bypassType', 'DriveType', 'temperatureSensor', 'size', 'placeholder1', 'placeholder2', 'sideRail', 'topRail', 'anschlussart'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => {
            if (id === 'DriveType') {
              updateDriveDependent();
            }
            updateProductCode();
          });
        });

        const toggleBtn = document.getElementById('toggle3D');
        toggleBtn.addEventListener('click', toggle3DView);

        handleProductFamilyChange();
        updateDriveDependent();
      }

      function handleProductFamilyChange() {
        const familyValue = document.getElementById('productFamily').value;
        const sizeSelect = document.getElementById('size');

        const sideRailGroup = document.getElementById('sideRailGroup');
        const topRailGroup = document.getElementById('topRailGroup');
        const railFamilies = ["Rail 1 (64mm)", "Rail 2 (94mm)", "Rail 3 (50mm)"];
        if (railFamilies.includes(familyValue)) {
          sideRailGroup.classList.remove('hidden');
          topRailGroup.classList.remove('hidden');
        } else {
          sideRailGroup.classList.add('hidden');
          topRailGroup.classList.add('hidden');
          const sr = document.getElementById('sideRail');
          const tr = document.getElementById('topRail');
          if (sr) sr.value = "";
          if (tr) tr.value = "";
        }

        if (familyValue !== "") {
          sizeSelect.disabled = false;
          const sizeOptionsForFamily = sizeOptions[familyValue] || [""];
          populateDropdown('size', sizeOptionsForFamily);
          sizeSelect.addEventListener('change', updateProductCode);
        } else {
          sizeSelect.disabled = true;
          sizeSelect.innerHTML = '<option value="">Select size...</option>';
        }

        updateProductCode();
      }

      function populateDropdown(dropdownId, optionsArray) {
        const select = document.getElementById(dropdownId);
        if (!select) return;
        select.innerHTML = '';
        optionsArray.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });
      }

      function updateDriveDependent() {
        const drive = document.getElementById('DriveType').value;
        const p1Label = document.getElementById('placeholder1Label');
        const p2Label = document.getElementById('placeholder2Label');
        const p1Select = document.getElementById('placeholder1');
        const p2Select = document.getElementById('placeholder2');
        const p2Group = document.getElementById('placeholder2Group');

        function setOptions(selectEl, arr) {
          if (! selectEl) return;
          selectEl.innerHTML = '';
          const empty = document.createElement('option');
          empty.value = '';
          empty.textContent = '--';
          selectEl.appendChild(empty);
          arr.forEach(optVal => {
            const o = document.createElement('option');
            o.value = optVal;
            o.textContent = optVal;
            selectEl.appendChild(o);
          });
        }

        if (drive === 'AC') {
          p1Label.textContent = 'Polzahl:  ';
          setOptions(p1Select, ['2', '4', '6', '8']);
          p2Label.textContent = 'Baugröße & performance';
          setOptions(p2Select, ['IEC-56 Low performance','IEC-56 High performance','IEC-63 Low performance','IEC-63 High performance','IEC-71 Low performance','IEC-71 High performance','IEC-80 Low performance','IEC-80 High performance','IEC-90 Low performance','IEC-90 High performance','IEC-100 Low performance','IEC-100 High performance','IEC-112 Medium performance','IEC-132 Low performance','IEC-132 Medium performance','IEC-132 High performance','IEC-160 Low performance','IEC-160 High performance']);
          p2Group.classList.remove('hidden');
        } else if (drive === 'DC - brushed') {
          p1Label. textContent = 'Steuerung position';
          setOptions(p1Select, ['Keine Stuerung','mit Steuerung am Lüftergehäuse oben montiert','mit Steuerung am Lüftergehäuse unten montiert','mit Steuerung am GT Gehäuse montiert','mit Steuerung am Siderail montiert','mit Steuerung am Toprail montiert']);
          p2Label.textContent = 'Voltage';
          setOptions(p2Select, ['12V Low performance','24V Low performance','12V Medium performance','24V Medium performance','12V High performance','24V High performance']);
          p2Group.classList.remove('hidden');
        } else if (drive === 'DC - brushless') {
          p1Label.textContent = 'Steuerung position';
          setOptions(p1Select, ['Keine Stuerung','mit Steuerung am Lüftergehäuse oben montiert','mit Steuerung am Lüftergehäuse unten montiert','mit Steuerung am GT Gehäuse montiert','mit Steuerung am Siderail montiert','mit Steuerung am Toprail montiert']);
          p2Label.textContent = 'Voltage';
          setOptions(p2Select, ['12V', '24V']);
          p2Group.classList. remove('hidden');
        } else if (drive === 'Hydraulic') {
          p1Label.textContent = 'Schluckvolumen / Umdrehung [cm³]';
          setOptions(p1Select, ['11', '00']);
          p2Group.classList.add('hidden');
          setOptions(p2Select, []);
        } else if (drive === 'Compact') {
          p1Label. textContent = 'Polzahl';
          setOptions(p1Select, ['2', '4', '6', '8']);
          p2Label.textContent = 'Voltage/Phases';
          setOptions(p2Select, ['230V / 1ph', '115V / 1ph', '230/400V / 3ph']);
          p2Group.classList. remove('hidden');
        } else {
          p1Label.textContent = 'Placeholder 1:';
          setOptions(p1Select, []);
          p2Label.textContent = 'Placeholder 2:';
          setOptions(p2Select, []);
          p2Group.classList.remove('hidden');
        }

        document.getElementById('placeholder1').value = '';
        document.getElementById('placeholder2').value = '';
      }

      function calculatePos1() {
        return "A";
      }

      function calculatePos2_3(productFamily) {
        const familyMap = {
          "Rail 1 (64mm)": "1T",
          "Rail 2 (94mm)": "2T",
          "Rail 3 (50mm)": "3T",
          "ASA-C Serie 50mm (ehem. Low Line)": "1C",
          "ASA-C Serie 64mm (ehem.  E-Serie)": "2C",
          "AUC-Serie, Standard (Anschluss links)": "1A",
          "AUC-Serie (ehem. AHP, Anschluss rechts)": "1A"
        };
        return familyMap[productFamily] || "";
      }

      function calculatePos4_5_6(size) {
        const sizeMap = {
          "45": "045", "75": "075", "105": "105", "135": "135", "175": "175", "235": "235", "275": "275", "375": "375", "385": "385",
          "177": "177", "257": "257", "367": "367", "467": "467", "567": "567", "927": "927",
          "6": "006", "7": "007", "9": "009", "13":  "013", "17": "017", "20": "020", "23": "023",
          "44": "044", "64": "064", "104": "104", "164": "164"
        };
        return sizeMap[size] || "";
      }

      function calculatePos7(bypassType) {
        const bypassMap = {
          "No Bypass": "N", "Thermal Bypass": "T", "Pressure Bypass 2 bar": "P", "Pressure Bypass 5 bar": "P", "Pressure Bypass Special": "P!"
        };
        return bypassMap[bypassType] || "";
      }

      function calculatePos8(driveType) {
        const mountingMap = { "AC": "A", "DC - brushed": "D", "DC - brushless": "B", "Compact": "C", "Hydraulic": "H" };
        return mountingMap[driveType] || "";
      }

      function calculatePos9(selections) {
        const drive = (selections.DriveType || "").trim();
        const p1 = (selections.placeholder1 || "").trim();

        const map = {
          "DC - brushed_Keine Stuerung": "0", "DC - brushed_mit Steuerung am Lüftergehäuse oben montiert": "U", "DC - brushed_mit Steuerung am Lüftergehäuse unten montiert": "D", "DC - brushed_mit Steuerung am GT Gehäuse montiert": "G", "DC - brushed_mit Steuerung am Siderail montiert": "S", "DC - brushed_mit Steuerung am Toprail montiert":  "T",
          "DC - brushless_Keine Stuerung": "0", "DC - brushless_mit Steuerung am Lüftergehäuse oben montiert": "U", "DC - brushless_mit Steuerung am Lüftergehäuse unten montiert": "D", "DC - brushless_mit Steuerung am GT Gehäuse montiert": "G", "DC - brushless_mit Steuerung am Siderail montiert": "S", "DC - brushless_mit Steuerung am Toprail montiert": "T",
          "AC_2": "2", "AC_4": "4", "AC_6": "6", "AC_8": "8",
          "Compact_2": "2", "Compact_4": "4", "Compact_6": "6", "Compact_8": "8",
          "Hydraulic_00": "0", "Hydraulic_11": "1"
        };

        const key = `${drive}_${p1}`;
        if (map. hasOwnProperty(key)) return map[key];

        if ((drive === "AC" || drive === "Compact") && ["2", "4", "6", "8"].includes(p1)) return p1;
        if (drive === "Hydraulic") {
          if (p1 === "00") return "0";
          if (p1 === "11") return "1";
        }
        if ((drive === "DC - brushed" || drive === "DC - brushless") && /^(keine|none|0)$/i.test(p1)) return "0";

        return "";
      }

      function calculatePos10(selections) {
        const drive = (selections.DriveType || "").trim();
        const p2 = (selections.placeholder2 || "").trim();
        const p1 = (selections.placeholder1 || "").trim();

        const map = {
          "AC": {
            "IEC-56 Low performance": "A", "IEC-56 High performance": "B", "IEC-63 Low performance": "C", "IEC-63 High performance": "D",
            "IEC-71 Low performance": "E", "IEC-71 High performance": "F", "IEC-80 Low performance": "G", "IEC-80 High performance": "H",
            "IEC-90 Low performance": "I", "IEC-90 High performance": "J", "IEC-100 Low performance": "K", "IEC-100 High performance": "L",
            "IEC-112 Medium performance": "M", "IEC-132 Low performance": "N", "IEC-132 Medium performance": "O", "IEC-132 High performance": "P",
            "IEC-160 Low performance": "Q", "IEC-160 High performance": "R"
          },
          "DC - brushed": { "12V Low performance": "1", "24V Low performance": "2", "12V Medium performance": "3", "24V Medium performance": "4", "12V High performance": "5", "24V High performance": "6" },
          "DC - brushless": { "12V":  "1", "24V": "2" },
          "Compact": { "230V / 1ph": "E", "115V / 1ph": "U", "230/400V / 3ph": "D" },
          "Hydraulic": {}
        };

        const hydraulicMap = { "11": "1", "00": "0" };
        if (drive === "Hydraulic") {
          if (hydraulicMap.hasOwnProperty(p1)) return hydraulicMap[p1];
          return "";
        }

        if (map.hasOwnProperty(drive)) {
          const driveMap = map[drive];
          if (driveMap && driveMap.hasOwnProperty(p2)) return driveMap[p2];
        }
        return "";
      }

      function calculatePos11_12(sideRailValue) {
        if (! sideRailValue) return ["", ""];
        const v = String(sideRailValue);
        if (v. length === 2) return [v.charAt(0), v.charAt(1)];
        if (v.length === 1) return [v.charAt(0), ""];
        return ["", ""];
      }

      function calculatePos13(anschlussValue) {
        return anschlussValue || "";
      }

      function calculatePos15_fromTopRail(topRailValue) {
        return topRailValue || "";
      }

      function calculatePos14(temperatureSensor) {
        const tempSensorMap = {
          "No Sensor": "0", "Temperature Sensor Standard": "T", "Temperature Switch 40°C": "4", "Temperature Switch 50°C": "5",
          "Temperature Switch 60°C": "6", "Temperature Switch 70°C": "7", "Temperature Switch 80°C":  "8", "Temperature Switch 90°C": "9", "Temperature Control AC": "A"
        };
        return tempSensorMap[temperatureSensor] || "";
      }

      function updatePositionBox(position, value) {
        const box = document.getElementById(`pos${position}`);
        if (box) {
          if (value && value !== "") {
            box.textContent = value;
            box.classList.add('filled');
          } else {
            box.textContent = "-";
            box.classList.remove('filled');
          }
        }
      }

      function applyAnschlussOverlay(selections) {
        const overlay = document.getElementById('overlayImage');
        const preview = document.getElementById('previewImage');

        if (!selections.anschlussart || selections.anschlussart !== 'M') {
          overlay.style.display = 'none';
          return;
        }

        const keysToTry = [
          `${selections.productFamily}|${selections.size}`,
          `${selections.productFamily}|*`,
          `*|${selections.size}`,
          '*'
        ];

        let cfg = null;
        for (const k of keysToTry) {
          if (k === '*') {
            cfg = overlayDefault;
            break;
          }
          if (overlayMap[k]) { cfg = overlayMap[k]; break; }
        }
        if (!cfg) cfg = overlayDefault;

        overlay.src = anschlussMOverlaySrc;
        overlay.style.display = 'block';

        const rect = preview.getBoundingClientRect();
        const W = rect.width;
        const H = rect.height;

        if (W === 0 || isNaN(W)) {
          overlay.style.display = 'none';
          return;
        }

        const leftPx = (cfg.left / 100) * W;
        const topPx = (cfg.top / 100) * H;
        const widthPx = (cfg.width / 100) * W;

        overlay.style.left = `${leftPx}px`;
        overlay.style.top = `${topPx}px`;
        overlay.style.width = `${widthPx}px`;
        overlay.style.height = 'auto';
        overlay.style.display = 'block';
      }

      function updateProductCode() {
        const selections = getCurrentSelections();

        const pos1 = calculatePos1();
        const pos2_3 = calculatePos2_3(selections.productFamily);
        const pos4_5_6 = calculatePos4_5_6(selections.size);
        const pos7 = calculatePos7(selections.bypassType);
        const pos8 = calculatePos8(selections.DriveType);
        const pos14 = calculatePos14(selections. temperatureSensor);

        updatePositionBox(1, pos1);

        if (pos2_3.length >= 2) {
          updatePositionBox(2, pos2_3.charAt(0));
          updatePositionBox(3, pos2_3.charAt(1));
        } else {
          updatePositionBox(2, "");
          updatePositionBox(3, "");
        }

        if (pos4_5_6.length >= 3) {
          updatePositionBox(4, pos4_5_6.charAt(0));
          updatePositionBox(5, pos4_5_6.charAt(1));
          updatePositionBox(6, pos4_5_6.charAt(2));
        } else {
          updatePositionBox(4, "");
          updatePositionBox(5, "");
          updatePositionBox(6, "");
        }

        updatePositionBox(7, pos7);
        updatePositionBox(8, pos8);

        const pos9 = calculatePos9(selections);
        updatePositionBox(9, pos9);

        const pos10 = calculatePos10(selections);
        updatePositionBox(10, pos10);

        const sideValue = selections.sideRail || "";
        const [p11, p12] = calculatePos11_12(sideValue);
        updatePositionBox(11, p11);
        updatePositionBox(12, p12);

        const pos13 = calculatePos13(selections.anschlussart);
        updatePositionBox(13, pos13);

        updatePositionBox(14, pos14);

        const pos15 = calculatePos15_fromTopRail(selections.topRail);
        updatePositionBox(15, pos15);

        const positions = [];
        for (let i = 1; i <= 18; i++) {
          const box = document.getElementById(`pos${i}`);
          const value = box ?  box.textContent : "";
          positions.push(value === "-" ? "" : value);
        }

        const finalCode = positions.join("").replace(/^-+|-+$/g, "");
        document.getElementById('finalCode').textContent = finalCode || "Select options to generate code...  ";

        const key = `${selections.productFamily}|${selections.size}`;
        const previewImage = document.getElementById('previewImage');
        if (specialImageMap[key]) {
          previewImage.src = specialImageMap[key];
          previewImage.alt = `Special image for ${key}`;
        } else {
          const imgPath = `/shared/images/${finalCode}.png`;
          previewImage.src = imgPath;
          previewImage.alt = finalCode || "Preview";
        }

        update3DModel(selections);
        setTimeout(() => applyAnschlussOverlay(selections), 30);
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initializeDropdowns();
        updateProductCode();
      });
    </script>

    <div class="copyright">
      © 2024 mo5ali & <a href="https://claude.ai" target="_blank">Claude</a>
    </div>
  </body>
</html>